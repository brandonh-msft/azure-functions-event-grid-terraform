pr: none
trigger:
  branches:
    include:
    - develop
  paths:
    include:
    - infrastructure/
    - src/

variables:
- name: artifactName
  value: FunctionApp
- name: PipelineVariableDir
  value: $(Pipeline.Workspace)/variables
- name: serviceConnectionName
  value: my-azure

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: BuildFunctionsArtifact
  displayName: Build Functions Artifact
  variables:
    buildConfiguration: 'Release'
    workingDirectory:   '$(Build.SourcesDirectory)/src/$(artifactName)'
    functionAppProjectName:  '$(artifactName).csproj'
    packDirectory: '$(Build.ArtifactStagingDirectory)'
    downloadDirectory: '$(Build.SourcesDirectory)/downloadDirectory'

  jobs:
    - job: BuildFunctionAppArtifact
      steps:
      - task: UseDotNet@2
        displayName: 'Use .NET Core sdk 3.1'
        inputs:
          packageType: sdk
          version: 3.1.x
      
      - task: DotNetCoreCLI@2
        displayName: 'dotnet build function app'
        inputs:
          command: build
          projects: '**/*$(functionAppProjectName)'
          arguments: '--configuration $(BuildConfiguration) --output $(packDirectory)'
          workingDirectory: $(workingDirectory)
          modifyOutputPath: true      - publish: $(packDirectory)
        artifact: $(artifactName)

- template: templates/deploy-to-env-template.yml
  parameters:
    packDirectory: '$(Build.ArtifactStagingDirectory)'
